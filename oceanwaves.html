<!DOCTYPE html>
<html data-bs-theme="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Ocean Wave Simulation</title>
    <link href="css/custom.css" rel="stylesheet">
</head>
<body>

<div class="container-fluid">
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <button aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
                    class="navbar-toggler" data-bs-target="#navbarSupportedContent"
                    data-bs-toggle="collapse" type="button">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a aria-current="page" class="nav-link active" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://itch.io/profile/carrotcakevr">Itch.io</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/FeveredCarrot">Github</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mailto:jaspermclean10@gmail.com">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <h1 class="title display-4 text-center p-3">Ocean Wave Simulation</h1>
        <div class="row">
            <div class="col"></div>
            <div class="col-xl-12 justify-content-center">
                <video autoplay class="img-fluid m-3" loop muted>
                    <source src="videos/WavesPreview.mp4">
                </video>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col"></div>
            <div class="blog-center-col">
                <p class="blog-text">As part of a larger game project (that I never finished), I set out to create a
                    detailed, flexible, and performant ocean simulation closely following the techniques outlined by
                    Acerola and Jump Trajectory in their videos on the subject. I also made extensive use of the
                    research papers referenced in those videos - mainly "Simulating Ocean Water" by Jerry Tessendorf and
                    "Realtime GPGPU FFT
                    Ocean Water Simulation" by Fynn-Jorin Flügge. Although I never finished the rest of the game, I
                    consider the ocean simulation itself to be my proudest achievement as a programmer.</p>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col">
            </div>
            <div class="blog-center-col">
                <p class="blog-text">My initial idea was to use many Gerstner waves (circular waves) layered together
                    to generate an animated displacement map of the ocean surface. However, using the CPU to generate
                    enough waves for a sufficiently detailed ocean is far too expensive. Luckily, I discovered a much
                    more robust technique using a GPU implementation of the magical fast Fourier transform (FFT)
                    algorithm to generate the displacement map from a frequency domain representation of the ocean's
                    waves.</p>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col"></div>
            <div class="blog-double-column">
                <p class="blog-text">I used the JONSWAP ocean wave spectrum function and a Cosine-2s directional
                    spreading function to generate the frequency domain representation of the initial ocean state. The
                    result is a texture where wave frequency is represented as the distance from the center, wave
                    direction is the direction from the center, and a complex amplitude is stored in the red and green
                    channels of each pixel. The red and green channels are also multiplied by random gaussian
                    distributed noise to create a natural distribution of wave phase and amplitude. There's also another
                    step that involves generating an additional complex conjugate version of the frequency spectrum but
                    I won't get too much into that.</p>
            </div>
            <div class="blog-double-column">
                <figure><img alt="images/MediaObj_Placeholder.png" class="img-fluid" src="images/SpectrumPreview.png">
                    <figcaption class="text-light">Wave frequency spectrum texture.</figcaption>
                </figure>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col"></div>
            <div class="blog-double-column">
                <p class="blog-text">After generating the frequency domain of the initial ocean state, we advance the
                    frequencies forward in time by using Euler's formula (and some other math) to rotate each pixel
                    around the complex plane. The resulting fourier components texture can be run through an inverse FFT
                    (IFFT)
                    to become the heightmap of the ocean at the specified time, but before we do that, we can derive
                    additional fourier components textures for the horizontal displacements of the Gerstner waves and
                    for the slope on each axis (for normal mapping) using a few complex multiplications.</p>
            </div>
            <div class="blog-double-column">
                <figure>
                    <video autoplay class="img-fluid" loop muted>
                        <source src="videos/FourierComponentsPreview.mp4">
                    </video>
                    <figcaption class="text-light">Fourier components texture animating through time.</figcaption>
                </figure>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col"></div>
            <div class="blog-center-col">
                <p class="blog-text">Finally, we run each fourier components texture through a 2D inverse FFT
                    algorithm on the GPU to generate the X, Y, and Z displacements along with derivative maps to be used
                    as fragment normals. I implemented the inverse FFT using a compute shader version of the
                    Cooley-Tukey FFT algorithm as described by Fynn-Jorin Flügge in their thesis paper. This involves
                    pre-computing a "butterfly texture" that contains the "twiddle factors" for each stage of the divide
                    and conquer algorithm. The butterfly texture is then used in another compute shader for a horizontal
                    and vertical IFFT
                    pass on the fourier components texture. I still haven't wrapped my head around how the entire thing
                    works; I
                    honestly consider it to be as close as you can get to real magic because the result of the IFFT is a
                    highly
                    detailed displacement and slope map of the ocean that tiles seamlessly, animates realistically, and
                    runs smoothly. Profiling it on my machine, it takes about 5ms each frame, and I know theres probably
                    a lot of ways I could optimize it further.
                </p>
            </div>

            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col-xl-2 align-content-center">
                <figure>
                    <img alt="images/MediaObj_Placeholder.png" class="img-fluid" src="images/ButterfyPreview.png">
                    <figcaption class="text-light">Butterfly texture.</figcaption>
                </figure>
            </div>
            <div class="blog-double-column">
                <figure>
                    <video autoplay class="img-fluid" loop muted>
                        <source src="videos/DisplacementPreview.mp4">
                    </video>
                    <figcaption class="text-light">Final displacement map. RGB channels correspond to XYZ
                        displacement.
                    </figcaption>
                </figure>
            </div>
            <div class="blog-double-column">
                <figure>
                    <video autoplay class="img-fluid" loop muted>
                        <source src="videos/SlopePreview.mp4">
                    </video>
                    <figcaption class="text-light">Slope map used for fragment shader normals.</figcaption>
                </figure>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col"></div>
            <div class="blog-center-col">
                <p class="blog-text">I haven't mentioned that I'm using the anti-tiling technique described in the
                    Acerola and Jump Trajectory videos where we split the frequncy domain into multiple cascades for the
                    low, medium, and high frequency waves. The inverse FFT is performed for each of the frequency
                    cascades so that we can layer each displacement map on top of each other at different scales. The
                    effect of this is that the large waves tile over much a larger area, and the smaller waves that tile
                    more frequently are latered on top. Even with three cascades, the effect of tiling is almost
                    eliminated while the fine details are preserved.
                </p>
            </div>
            <div class="col"></div>
        </div>
    </div>
</div>
<footer class="footer-pad"></footer>
<script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>